import streamlit as st
import google.generativeai as genai
from PIL import Image
import tempfile
import os

# --- ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ ---
st.set_page_config(
    page_title="ุงููุฏูู ุงูุฐูู - ุฃูุงูุฉ ููุทูุฉ ุงูุฑูุงุถ",
    page_icon="๐๏ธ",
    layout="wide"
)

# --- ุงููุงุฌูุฉ ุงูุฌุงูุจูุฉ (Sidebar) ---
with st.sidebar:
    st.image("https://www.alriyadh.gov.sa/Content/images/logo.png", width=200) # ุดุนุงุฑ ุงูุฃูุงูุฉ ุงูุชูุฑูุจู
    st.header("โ๏ธ ุงูุฅุนุฏุงุฏุงุช")
    api_key = st.text_input("ุฃุฏุฎู ููุชุงุญ Gemini API Key", type="password")
    st.info("ูุฐุง ุงููุธุงู ูุนูู ููุณูุฏุฉ ุฃูููุฉ ููุจุงุฏุฑุฉ ุงูุชุฏููู ุงูุฐูู.")
    st.markdown("---")
    st.write("ุฅุนุฏุงุฏ: ู. ุณูุทุงู ุนุจูุฏ ุงูุดูุฑู")

# --- ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ ---
st.title("๐๏ธ ูุธุงู ุงูุชุฏููู ุงููุนูุงุฑู ุงูุฐูู")
st.subheader("ุฅุฏุงุฑุฉ ุฑุฎุต ุงูุจูุงุก - ูุทุงุน ุงูุดูุงู")
st.markdown("---")

# ุชูุณูู ุงูุดุงุดุฉ ูุนููุฏูู
col1, col2 = st.columns([1, 1])

reference_file = None
plan_image = None

with col1:
    st.success("### 1๏ธโฃ ุงูุฎุทูุฉ ุงูุฃููู: ุงููุฑุฌุน ุงููุธุงูู")
    uploaded_ref = st.file_uploader("ุงุฑูุน ููู (ุงูุฏููู ุงูููุญุฏ ููุงุดุชุฑุงุทุงุช) PDF", type=["pdf"])
    
    st.info("### 2๏ธโฃ ุงูุฎุทูุฉ ุงูุซุงููุฉ: ูุฎุทุท ุงููุดุฑูุน")
    uploaded_plan = st.file_uploader("ุงุฑูุน ุตูุฑุฉ ุงููุฎุทุท ุงููุนูุงุฑู (ุงููุณูุท ุงูุฃููู)", type=["jpg", "png", "jpeg"])

# --- ุงูููุทู ุงูุจุฑูุฌู ---
if uploaded_ref and uploaded_plan and api_key:
    # ุฅุนุฏุงุฏ Gemini
    genai.configure(api_key=api_key)
    
    # ุฒุฑ ุงูุชุดุบูู
    if st.button("๐ ุจุฏุก ุงูุชุฏููู ุงูุขูู", type="primary"):
        with st.spinner("ุฌุงุฑู ุชุญููู ุงููุฎุทุท ููุทุงุจูุชู ูุน ุงูุฏููู ุงูููุญุฏ... (ูุฏ ูุณุชุบุฑู ุงูุฃูุฑ ุฏูููุฉ)"):
            try:
                # 1. ูุนุงูุฌุฉ ููู ุงูุฏููู (PDF)
                # ูุญุชุงุฌ ูุญูุธู ูุคูุชุงู ูุฑูุนู ูู Gemini
                with tempfile.NamedTemporaryFile(delete=False, suffix=".pdf") as tmp_ref:
                    tmp_ref.write(uploaded_ref.getvalue())
                    tmp_ref_path = tmp_ref.name
                
                # ุฑูุน ุงูููู ุฅูู Gemini Files API
                ref_file_upload = genai.upload_file(path=tmp_ref_path, display_name="Unified Guide")
                
                # 2. ูุนุงูุฌุฉ ุตูุฑุฉ ุงููุฎุทุท
                plan_image = Image.open(uploaded_plan)

                # 3. ุงูุชุนูููุงุช (ุงูุจุฑููุจุช ุงูุฐู ูุชุจุชู ุฃูุช)
                system_prompt = """
                ุฃูุช ูููุฏุณ ูุฏูู ุฎุจูุฑ ูู ุฅุฏุงุฑุฉ ุฑุฎุต ุงูุจูุงุก ุจุฃูุงูุฉ ููุทูุฉ ุงูุฑูุงุถ.
                ุงููุฑุฌุน ุงููุญูุฏ ูุงูุญุตุฑู ูู ููู PDF ุงููุฑูู (ุงูุฏููู ุงูููุญุฏ).
                
                ุงููููุฉ:
                ูู ุจูุณุญ ุตูุฑุฉ ุงููุฎุทุท ุงููุฑููุฉ ุจุตุฑูุงูุ ูุงุณุชุฎุฑุฌ ุงูุจูุงูุงุช ุงูุชุงููุฉ ููุงุฑููุง ุจุฌุฏูู ุงูุงุดุชุฑุงุทุงุช ุงูููุงุณุจ ูู ููู ุงูุฏููู ุงููุฑูู.
                
                ุงููุฎุฑุฌุงุช ุงููุทููุจุฉ (ุฌุฏูู ุญุตุฑุงู):
                1. ุญุฏุฏ ููุน ุงููุจูู (ูููุง/ุนูุงุฑุฉ/ุชุฌุงุฑู).
                2. ูุงุฑู ูุณุจุฉ ุงูุจูุงุก (ุงูุชุบุทูุฉ) ูู ุงูุฏูุฑ ุงูุฃุฑุถู.
                3. ูุงุฑู ุงูุงุฑุชุฏุงุฏ ุงูุฃูุงูู ูุงููุฌุงูุฑูู.
                4. ุงุญุณุจ ุนุฏุฏ ุงูููุงูู ูุชุฃูุฏ ูู ูุทุงุจูุชูุง ูููุนุงุฏูุฉ ูู ุงูุฏููู.
                5. ุชุฃูุฏ ูู ูุฌูุฏ (ุงูุดุทูุฉ) ูู ุงูุฒุงููุฉ ุฅุฐุง ูุงูุช ุงูุฃุฑุถ ุฒุงููุฉ.
                
                ูุฏู ุงูุชูุฑูุฑ ุนูู ุดูู ุฌุฏูู Markdown ูุญุชูู:
                | ุนูุตุฑ ุงูุชุฏููู | ุงููููุฉ ูู ุงููุฎุทุท | ุงููุทููุจ ูู ุงูุฏููู | ุงูุญุงูุฉ (ูุทุงุจู/ูุฎุงูู) | ุฑูู ุงูุตูุญุฉ ูู ุงูุฏููู |
                
                ููุงุญุธุฉ: ูู ุฏูููุงู ูุญุงุฒูุงู.
                """

                # 4. ุฅุฑุณุงู ุงูุทูุจ ูููููุฐุฌ (ูุณุชุฎุฏู Gemini 1.5 Flash ูุณุฑุนุชู ููุฏุฑุชู ุนูู ูุฑุงุกุฉ ุงููููุงุช)
                model = genai.GenerativeModel('gemini-1.5-flash')
                response = model.generate_content([system_prompt, ref_file_upload, plan_image])

                # 5. ุนุฑุถ ุงููุชูุฌุฉ
                st.balloons()
                with col2:
                    st.markdown("### โ ุชูุฑูุฑ ุงูุชุฏููู:")
                    st.markdown(response.text)
                    
                # ุชูุธูู ุงูููู ุงููุคูุช
                os.remove(tmp_ref_path)

            except Exception as e:
                st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงููุนุงูุฌุฉ: {e}")
else:
    with col2:
        st.warning("โ๏ธ ูุฑุฌู ุฅุฏุฎุงู ููุชุงุญ API ูุฑูุน ุงููููุงุช ููุจุฏุก.")

