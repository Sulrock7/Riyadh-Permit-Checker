import streamlit as st
import google.generativeai as genai
from PIL import Image
import io

# --- ุฅุนุฏุงุฏ ุงูุตูุญุฉ ---
st.set_page_config(
    page_title="ูุฏูู ุฑุฎุต ุงูุจูุงุก - ุฃูุงูุฉ ุงูุฑูุงุถ",
    page_icon="๐๏ธ",
    layout="wide"
)

# --- ุงููุงุฌูุฉ ุงูุฌุงูุจูุฉ ---
with st.sidebar:
    st.title("โ๏ธ ุงูุฅุนุฏุงุฏุงุช")
    api_key = st.text_input("ููุชุงุญ Google API Key", type="password")
    st.info("ูุณุชุฎุฏู ููุง ููุฏูู Gemini 1.5 Pro ุงููุชูุฏู ููุญุตูู ุนูู ููุณ ุฏูุฉ AI Studio.")

# --- ุงูุนููุงู ---
st.title("๐๏ธ ูุธุงู ุงูุชุฏููู ุงูุขูู (ูุณุฎุฉ ุงููููุฏุณ ุณูุทุงู)")
st.markdown("ูุณุชุฎุฏู ูุฐุง ุงููุธุงู ููุณ ุงููุญุฑู ุงูุฐูู ุงูููุฌูุฏ ูู Google AI Studio ููุฑุงุกุฉ ุงููุฎุทุทุงุช ูุงูุฌุฏุงูู ุจุฏูุฉ.")
st.markdown("---")

# --- ุงูุชุนูููุงุช (ุงูุนูู ุงููุฏุจุฑ) ---
system_instruction = """
ุฃูุช ูููุฏุณ ูุฏูู ุฎุจูุฑ ูู ุฃูุงูุฉ ููุทูุฉ ุงูุฑูุงุถ.
ุงููุฑุฌุน: ุงูุฏููู ุงูููุญุฏ ูุงุดุชุฑุงุทุงุช ุฑุฎุต ุงูุจูุงุก.

ุงููููุฉ:
ุนูุฏ ุงุณุชูุงู ูุฎุทุท (ุตูุฑุฉ ุฃู PDF)ุ ูู ุจูุณุญู ุจุตุฑูุงู ุจุฏูุฉ ุนุงููุฉ ุฌุฏุงู (Pixel-level) ูุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ุงูุชุงููุฉ ูู ุฌุฏูู:
1. ููุน ุงููุจูู ูุงููุดุงุท.
2. ุจูุงูุงุช ุงูุฌุฏูู ุงูุชูุธููู ูู ุงููุฎุทุท (ุงููุณุจุ ุงูุงุฑุชุฏุงุฏุงุชุ ุงููุณุงุญุงุช).
3. ูุทุงุจูุฉ ูุฐู ุงูุฃุฑูุงู ูุน ุงูุฏููู ุงูููุญุฏ.

ุงููุฎุฑุฌุงุช:
ุฌุฏูู ุชุฏููู ูุงุถุญ ููุถุญ (ุงูุนูุตุฑ - ุงูููุฌูุฏ ูู ุงููุฎุทุท - ุงููุทููุจ ูู ุงูููุฏ - ุงูุญุงูุฉ).
ูู ุตุงุฑูุงู: ุฅุฐุง ูุงู ุงูุฑูู ุบูุฑ ูุงุถุญุ ุงูุชุจ "ุบูุฑ ูุงุถุญ".
"""

# --- ุงูููุทู ุงูุจุฑูุฌู ---
if api_key:
    genai.configure(api_key=api_key)
    
    # 1. ูุงุฌูุฉ ุงูุฑูุน
    uploaded_file = st.file_uploader("ุงุฑูุน ุงููุฎุทุท (ุตูุฑุฉ ุฃู PDF)", type=["jpg", "png", "jpeg", "pdf"])

    if uploaded_file:
        # ุฒุฑ ุงูุชุญููู
        if st.button("ุจุฏุก ุงูุชุฏููู ุงูุนููู ๐"):
            with st.spinner('ุฌุงุฑู ุงูุงุชุตุงู ุจู Google Gemini Pro 1.5... ูุฑุฌู ุงูุงูุชุธุงุฑ ููุชุญููู ุงูุฏููู'):
                try:
                    # ุชุฌููุฒ ุงูููู
                    file_data = {"mime_type": uploaded_file.type, "data": uploaded_file.getvalue()}
                    
                    # 2. ุงุณุชุฏุนุงุก ุงูููุฏูู (ููุง ุงูุฅุตูุงุญ: ูุณุชุฎุฏู ุงููุณุฎุฉ ุงููุณุชูุฑุฉ)
                    model = genai.GenerativeModel(
                        model_name="gemini-1.5-pro",  # ูุฐุง ูู ุงูููุฏูู ุงูุฐูู
                        system_instruction=system_instruction
                    )
                    
                    # ุฅุนุฏุงุฏุงุช ุงูุชูููุฏ (ูุฒูุงุฏุฉ ุงูุฏูุฉ ูุชูููู ุงูุชุฃููู)
                    generation_config = genai.types.GenerationConfig(
                        temperature=0.0, # ุตูุฑ ูุนูู ุฏูุฉ ูุตูู ูุนุฏู ุชุฃููู
                    )

                    # 3. ุฅุฑุณุงู ุงูุทูุจ
                    response = model.generate_content(
                        ["ูู ุจุชุญููู ูุฐุง ุงููุฎุทุท ุจุฏูุฉ ููุฏุณูุฉ ูุงุณุชุฎุฑุฌ ุฌุฏุงูู ุงูุจูุงูุงุช ููุงุฑููุง ุจุงูููุฏ.", file_data],
                        generation_config=generation_config
                    )
                    
                    # 4. ุนุฑุถ ุงููุชูุฌุฉ
                    st.success("ุชู ุงูุชุญููู ุจูุฌุงุญ!")
                    st.markdown(response.text)
                    
                except Exception as e:
                    st.error(f"ุญุฏุซ ุฎุทุฃ: {e}")
                    st.warning("ุชุฃูุฏ ุฃู ููุชุงุญ API ุตุญูุญุ ูุฃู ุงููุฎุทุท ููุณ ูุจูุฑุงู ุฌุฏุงู (ุฃูุจุฑ ูู 20 ููุฌุง).")

else:
    st.warning("๐ ูุฑุฌู ูุถุน ููุชุงุญ API ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ููุจุฏุก.")
